'use client';

import React from 'react';
import { Calendar, dateFnsLocalizer, View } from 'react-big-calendar';
import { format, parse, startOfWeek, getDay } from 'date-fns';
import { enUS } from 'date-fns/locale/en-US';
import { useEventsStore } from '@/stores/eventsStore';
import { useUserStore } from '@/stores/userStore';
import { TRCEvent, EventType, EventPriority, EventStatus, UserPersona } from '@/types';
import { EventModal } from './EventModal';
import { AddEventModal } from './AddEventModal';
import { 
  CalendarDaysIcon, 
  PlusIcon,
  EyeIcon,
  DocumentTextIcon 
} from '@heroicons/react/24/outline';
import { cn, getEventTypeColor, getPriorityColor } from '@/lib/utils';
import 'react-big-calendar/lib/css/react-big-calendar.css';
import '@/styles/calendar.css';

const localizer = dateFnsLocalizer({
  format,
  parse,
  startOfWeek,
  getDay,
  locales: {
    'en-US': enUS,
  },
});

// Create a context for calendar actions
const CalendarContext = React.createContext<{
  handleAddEvent: () => void;
} | null>(null);

export const useCalendarContext = () => {
  const context = React.useContext(CalendarContext);
  return context;
};

interface TRCCalendarWidgetProps {
  config: {
    view?: string;
    showEventTypes?: string[];
    enableAdmin?: boolean;
  };
}

// Calendar Controls Component - can be rendered separately
export function CalendarControls({ config }: {
  config: TRCCalendarWidgetProps['config'];
}) {
  const calendarContext = useCalendarContext();
  
  return (
    <>
      {/* Add Event Button */}
      {config.enableAdmin && calendarContext && (
        <button
          onClick={calendarContext.handleAddEvent}
          className="flex items-center space-x-1 px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
          aria-label="Add new event"
          title="Add Event"
        >
          <PlusIcon className="w-3 h-3" />
          <span className="hidden sm:inline">Add</span>
        </button>
      )}
    </>
  );
}

export function TRCCalendarWidget({ config }: TRCCalendarWidgetProps) {
  const { events, addEvent, updateEvent, deleteEvent, getMyEvents } = useEventsStore();
  const { currentUser, getUsersByPersona } = useUserStore();
  
  const [isClient, setIsClient] = React.useState(false);
  const [currentDate, setCurrentDate] = React.useState<Date | null>(null);
  const [currentView, setCurrentView] = React.useState<View>((config.view as View) || 'month');
  const [selectedEvent, setSelectedEvent] = React.useState<TRCEvent | null>(null);
  const [showEventModal, setShowEventModal] = React.useState(false);
  const [showAddModal, setShowAddModal] = React.useState(false);
  const [isEditMode, setIsEditMode] = React.useState(false); // Track if we're editing or creating
  const [eventTypeFilter, setEventTypeFilter] = React.useState<EventType[]>(
    (config.showEventTypes as EventType[]) || Object.values(EventType)
  );
  const [priorityFilter, setPriorityFilter] = React.useState<EventPriority[]>(
    Object.values(EventPriority)
  );
  const [statusFilter, setStatusFilter] = React.useState<EventStatus[]>(
    Object.values(EventStatus)
  );
  const [showFilters, setShowFilters] = React.useState<boolean>(false);

  // Handle client-side rendering to prevent hydration mismatches
  React.useEffect(() => {
    setIsClient(true);
    setCurrentDate(new Date());
  }, []);

  const handleAddEvent = () => {
    const now = new Date();
    const endDate = new Date(now.getTime() + 60 * 60 * 1000); // 1 hour later
    
    console.log('Add Event button - Creating event for:', now);
    console.log('Add Event button - End date:', endDate);
    
    setSelectedEvent({
      id: '',
      title: '',
      description: '',
      startDate: now,
      endDate: endDate,
      type: EventType.INTERNAL_AUDIT,
      priority: EventPriority.MEDIUM,
      status: EventStatus.SCHEDULED,
      createdBy: 'current-user',
      createdAt: new Date(),
      updatedAt: new Date()
    });
    setShowAddModal(true);
  };

  const contextValue = React.useMemo(() => ({
    handleAddEvent
  }), []);

  return (
    <CalendarContext.Provider value={contextValue}>
      <CalendarWidgetContent 
        config={config}
        events={events}
        addEvent={addEvent}
        updateEvent={updateEvent}
        deleteEvent={deleteEvent}
        isClient={isClient}
        currentDate={currentDate}
        setCurrentDate={setCurrentDate}
        currentView={currentView}
        setCurrentView={setCurrentView}
        selectedEvent={selectedEvent}
        setSelectedEvent={setSelectedEvent}
        showEventModal={showEventModal}
        setShowEventModal={setShowEventModal}
        showAddModal={showAddModal}
        setShowAddModal={setShowAddModal}
        isEditMode={isEditMode}
        setIsEditMode={setIsEditMode}
        eventTypeFilter={eventTypeFilter}
        setEventTypeFilter={setEventTypeFilter}
        priorityFilter={priorityFilter}
        setPriorityFilter={setPriorityFilter}
        statusFilter={statusFilter}
        setStatusFilter={setStatusFilter}
        currentUser={currentUser}
        getUsersByPersona={getUsersByPersona}
      />
    </CalendarContext.Provider>
  );
}

// Main calendar content component
function CalendarWidgetContent({ 
  config,
  events,
  addEvent,
  updateEvent,
  deleteEvent,
  isClient,
  currentDate,
  setCurrentDate,
  currentView,
  setCurrentView,
  selectedEvent,
  setSelectedEvent,
  showEventModal,
  setShowEventModal,
  showAddModal,
  setShowAddModal,
  isEditMode,
  setIsEditMode,
  eventTypeFilter,
  setEventTypeFilter,
  priorityFilter,
  setPriorityFilter,
  statusFilter,
  setStatusFilter,
  currentUser,
  getUsersByPersona
}: any) {

  const filteredEvents = isClient ? events.filter((event: TRCEvent) => {
    // Filter by Event Type, Priority, and Status
    const matchesType = eventTypeFilter.includes(event.type);
    const matchesPriority = priorityFilter.includes(event.priority);
    const matchesStatus = statusFilter.includes(event.status);
    
    return matchesType && matchesPriority && matchesStatus;
  }) : [];

  const calendarEvents = isClient ? filteredEvents.map((event: TRCEvent) => {
    const startDate = new Date(event.startDate);
    const endDate = event.endDate ? new Date(event.endDate) : new Date(startDate.getTime() + 60 * 60 * 1000);
    
    // Ensure events are not marked as all-day unless they truly are
    const isAllDay = (endDate.getTime() - startDate.getTime()) >= (24 * 60 * 60 * 1000);
    
    const calendarEvent = {
      id: event.id,
      title: `${event.title}`,
      start: startDate,
      end: endDate,
      resource: event,
      allDay: false // Force timed events for day view
    };
    
    console.log('Mapping event:', event.title, 'Start:', startDate, 'End:', endDate, 'AllDay:', calendarEvent.allDay);
    return calendarEvent;
  }) : [];

  // Debug logging for events
  React.useEffect(() => {
    if (calendarEvents.length > 0) {
      console.log('Calendar Events:', calendarEvents);
      console.log('Current Date:', currentDate);
      console.log('Current View:', currentView);
      
      // Log today's events specifically
      const today = new Date();
      const todayEvents = calendarEvents.filter((event: any) => {
        const eventDate = new Date(event.start);
        return eventDate.toDateString() === today.toDateString();
      });
      console.log('Today\'s Events:', todayEvents);
    }
  }, [calendarEvents, currentDate, currentView]);

  const handleSelectEvent = (event: any) => {
    setSelectedEvent(event.resource);
    setIsEditMode(true); // Set to edit mode
    setShowAddModal(true); // Open AddEventModal in edit mode instead of EventModal
  };

  const handleSelectSlot = ({ start, end, slots }: { start: Date; end?: Date; slots?: Date[] }) => {
    if (config.enableAdmin && isClient) {
      console.log('Slot selected - Original start:', start);
      console.log('Slot selected - Original end:', end);
      console.log('Slot selected - All slots:', slots);
      console.log('Slot selected - Start date string:', start.toDateString());
      console.log('Slot selected - Start ISO string:', start.toISOString());
      console.log('Slot selected - Start local string:', start.toLocaleString());
      console.log('Slot selected - Current view:', currentView);
      
      // Create a new date to avoid timezone issues
      // For month view, we might want to default to a reasonable hour
      let localStart: Date;
      
      if (currentView === 'month') {
        // For month view, set to 9 AM of the selected date
        localStart = new Date(start.getFullYear(), start.getMonth(), start.getDate(), 9, 0);
      } else {
        // For week/day view, use the exact time clicked
        localStart = new Date(start.getFullYear(), start.getMonth(), start.getDate(), start.getHours(), start.getMinutes());
      }
      
      const endDate = new Date(localStart.getTime() + 60 * 60 * 1000); // 1 hour later
      
      console.log('Slot selected - Corrected start:', localStart);
      console.log('Slot selected - End date:', endDate);
      
      setSelectedEvent({
        id: '',
        title: '',
        description: '',
        startDate: localStart,
        endDate: endDate,
        type: EventType.INTERNAL_AUDIT,
        priority: EventPriority.MEDIUM,
        status: 'scheduled' as any,
        createdBy: 'current-user',
        createdAt: currentDate || new Date(),
        updatedAt: currentDate || new Date()
      });
      setIsEditMode(false); // Set to create mode
      setShowAddModal(true);
    }
  };

  const handleEventSave = (eventData: Partial<TRCEvent>) => {
    if (isEditMode && selectedEvent?.id) {
      // Update existing event
      updateEvent(selectedEvent.id, eventData);
      console.log('Event updated:', eventData);
    } else {
      // Create new event
      addEvent(eventData as Omit<TRCEvent, 'id' | 'createdAt' | 'updatedAt'>);
      console.log('Event added:', eventData);
    }
    setShowEventModal(false);
    setShowAddModal(false);
    setSelectedEvent(null);
  };

  const handleEventDelete = (eventId: string) => {
    deleteEvent(eventId);
    setShowEventModal(false);
    setSelectedEvent(null);
  };

  const handleViewChange = (view: View) => {
    console.log('View changed to:', view, 'Current date:', currentDate);
    setCurrentView(view);
  };

  const handleNavigate = (newDate: Date, view?: View, action?: string) => {
    console.log('Navigating to:', newDate, 'view:', view, 'action:', action);
    setCurrentDate(newDate);
  };

  // Custom toolbar component
  const CustomToolbar = ({ label, onNavigate, onView, view, views }: any) => {
    const goToBack = () => {
      onNavigate('PREV');
    };

    const goToNext = () => {
      onNavigate('NEXT');
    };

    const goToCurrent = () => {
      const today = new Date();
      console.log('Going to today:', today);
      onNavigate('TODAY');
    };

    return (
      <div className="trc-calendar-toolbar flex items-center justify-between p-4 bg-gray-50 border-b border-gray-200">
        <div className="flex items-center space-x-3">
          <button
            onClick={goToBack}
            className="flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
          >
            <svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
            </svg>
            Previous
          </button>
          
          <button
            onClick={goToCurrent}
            className="px-3 py-2 text-sm font-medium text-white bg-blue-600 border border-blue-600 rounded-md hover:bg-blue-700 transition-colors"
          >
            Today
          </button>
          
          <button
            onClick={goToNext}
            className="flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
          >
            Next
            <svg className="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
          </button>
        </div>

        <h2 className="text-lg font-semibold text-gray-900">{label}</h2>

        <div className="flex items-center space-x-1">
          {views.map((viewName: string) => (
            <button
              key={viewName}
              onClick={() => {
                console.log('Toolbar: switching to view:', viewName);
                onView(viewName);
              }}
              className={`px-3 py-2 text-sm font-medium rounded-md transition-colors ${
                view === viewName
                  ? 'bg-blue-600 text-white'
                  : 'text-gray-700 bg-white border border-gray-300 hover:bg-gray-50'
              }`}
            >
              {viewName.charAt(0).toUpperCase() + viewName.slice(1)}
            </button>
          ))}
        </div>
      </div>
    );
  };

  const eventStyleGetter = (event: any) => {
    const trcEvent: TRCEvent = event.resource;
    const baseStyle = {
      borderRadius: '6px',
      border: '1px solid rgba(255,255,255,0.2)',
      display: 'block',
      fontSize: '13px',
      fontWeight: '600',
      padding: '4px 6px',
      minHeight: '24px',
      lineHeight: '1.2',
      boxShadow: '0 1px 3px rgba(0,0,0,0.1)',
      zIndex: '10'
    };

    switch (trcEvent.priority) {
      case EventPriority.CRITICAL:
        return { 
          style: { 
            ...baseStyle, 
            backgroundColor: '#dc2626', 
            color: 'white',
            border: '2px solid #7f1d1d' 
          } 
        };
      case EventPriority.HIGH:
        return { 
          style: { 
            ...baseStyle, 
            backgroundColor: '#ea580c', 
            color: 'white',
            border: '2px solid #9a3412' 
          } 
        };
      case EventPriority.MEDIUM:
        return { 
          style: { 
            ...baseStyle, 
            backgroundColor: '#d97706', 
            color: 'white',
            border: '2px solid #92400e' 
          } 
        };
      case EventPriority.LOW:
        return { 
          style: { 
            ...baseStyle, 
            backgroundColor: '#059669', 
            color: 'white',
            border: '2px solid #064e3b' 
          } 
        };
      default:
        return { 
          style: { 
            ...baseStyle, 
            backgroundColor: '#6b7280', 
            color: 'white',
            border: '2px solid #374151' 
          } 
        };
    }
  };

  const upcomingEvents = isClient && currentDate ? filteredEvents
    .filter((event: TRCEvent) => {
      const eventDate = new Date(event.startDate);
      const now = new Date(currentDate);
      
      // Set the time to start of day for comparison to include events happening today
      const eventDateStart = new Date(eventDate.getFullYear(), eventDate.getMonth(), eventDate.getDate());
      const nowDateStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      
      return eventDateStart >= nowDateStart;
    })
    .sort((a: TRCEvent, b: TRCEvent) => new Date(a.startDate).getTime() - new Date(b.startDate).getTime())
    .slice(0, 5) : [];

  console.log('Filtered events count:', filteredEvents.length);
  console.log('Upcoming events count:', upcomingEvents.length);

  return (
    <div className="h-full flex flex-col overflow-hidden">
      <div className="flex-1 flex min-h-0 overflow-hidden">
        {/* Calendar */}
        <div className="flex-1 p-4 min-h-0 overflow-hidden flex flex-col">
          {/* Filter Section */}
          <div className="relative mb-4 flex justify-end">
            {/* Filter Toggle Button */}
            <div className="relative">
              <button
                onClick={() => setShowFilters(!showFilters)}
                className={cn(
                  "flex items-center gap-2 px-3 py-2 rounded-lg border transition-colors",
                  showFilters ? "bg-blue-50 border-blue-200 text-blue-700" : "bg-white border-gray-200 text-gray-600 hover:bg-gray-50"
                )}
              >
                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707v4.586l-4-2v-2.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                <span className="text-sm font-medium">Filters</span>
                {(eventTypeFilter.length !== Object.values(EventType).length || 
                  priorityFilter.length !== Object.values(EventPriority).length || 
                  statusFilter.length !== Object.values(EventStatus).length) && (
                  <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
                )}
              </button>

              {/* Filter Panel */}
              {showFilters && (
                <div className="absolute right-0 top-full mt-2 w-80 bg-white rounded-lg shadow-lg border border-gray-200 z-10 p-4">
                  <div className="space-y-4">
          </div>          <div className="flex-1 overflow-y-auto p-4 trc-upcoming-events-container">                    {/* Clear All Filters Button */}
                    <div className="pt-2 border-t border-gray-200">
                      <button
                        onClick={() => {
                          setEventTypeFilter(Object.values(EventType));
                          setPriorityFilter(Object.values(EventPriority));
                          setStatusFilter(Object.values(EventStatus));
                        }}
                        className="text-sm text-blue-600 hover:text-blue-700 font-medium"
                      >
                        Clear All Filters
                      </button>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>

          {isClient ? (
            <div className="flex-1 min-h-0">
              <Calendar
                localizer={localizer}
                events={calendarEvents}
                startAccessor="start"
                endAccessor="end"
                date={currentDate || new Date()}
                onNavigate={handleNavigate}
                view={currentView}
                onView={handleViewChange}
                onSelectEvent={handleSelectEvent}
                onSelectSlot={handleSelectSlot}
                selectable={config.enableAdmin || false}
                eventPropGetter={eventStyleGetter}
                style={{ height: '100%' }}
                className="trc-calendar"
                step={30}
                timeslots={2}
                showMultiDayTimes={true}
                popup={true}
                popupOffset={30}
                dayLayoutAlgorithm="no-overlap"
                min={new Date(1970, 1, 1, 6, 0, 0)} // 6 AM
                max={new Date(1970, 1, 1, 22, 0, 0)} // 10 PM
                scrollToTime={new Date(1970, 1, 1, 8, 0, 0)} // 8 AM
                components={{
                  toolbar: CustomToolbar,
                }}
                formats={{
                  eventTimeRangeFormat: ({ start, end }: any, culture: any, localizer: any) =>
                    `${localizer.format(start, 'HH:mm', culture)} - ${localizer.format(end, 'HH:mm', culture)}`,
                  agendaTimeFormat: 'HH:mm',
                  agendaTimeRangeFormat: ({ start, end }: any, culture: any, localizer: any) =>
                    `${localizer.format(start, 'HH:mm', culture)} - ${localizer.format(end, 'HH:mm', culture)}`
                }}
              />
            </div>
          ) : (
            <div className="flex items-center justify-center flex-1 text-gray-500">
              <div className="text-center">
                <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                <p>Loading calendar...</p>
              </div>
            </div>
          )}
        </div>

        {/* Sidebar */}
        <div className="w-72 border-l border-gray-100 bg-gray-50 flex flex-col min-h-0">
          <div className="p-4 border-b border-gray-200 bg-gray-50">
            <div className="flex items-center justify-between mb-3">
              <h4 className="font-medium text-gray-900 flex items-center">
                <EyeIcon className="w-4 h-4 mr-2" />
                Upcoming Events
              </h4>
              <span className="text-sm text-gray-500">
                {upcomingEvents.length} events
              </span>
            </div>
            
              {/* Event Type Filter */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Event Type</label>
                <div className="space-y-1 max-h-32 overflow-y-auto">
                  {Object.values(EventType).map(type => (
                    <label key={type} className="flex items-center text-sm">
                      <input
                        type="checkbox"
                        className="h-3 w-3 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                        checked={eventTypeFilter.includes(type)}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setEventTypeFilter([...eventTypeFilter, type]);
                          } else {
                            setEventTypeFilter(eventTypeFilter.filter((t: EventType) => t !== type));
                          }
                        }}
                      />
                      <span className="ml-2 text-gray-600">{type.replace('_', ' ')}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Priority Filter */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Priority</label>
                <div className="space-y-1">
                  {Object.values(EventPriority).map(priority => (
                    <label key={priority} className="flex items-center text-sm">
                      <input
                        type="checkbox"
                        className="h-3 w-3 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                        checked={priorityFilter.includes(priority)}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setPriorityFilter([...priorityFilter, priority]);
                          } else {
                            setPriorityFilter(priorityFilter.filter((p: EventPriority) => p !== priority));
                          }
                        }}
                      />
                      <span className="ml-2 text-gray-600">{priority}</span>
                    </label>
                  ))}
                </div>
              </div>

              {/* Status Filter */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <div className="space-y-1">
                  {Object.values(EventStatus).map(status => (
                    <label key={status} className="flex items-center text-sm">
                      <input
                        type="checkbox"
                        className="h-3 w-3 text-blue-600 rounded border-gray-300 focus:ring-blue-500"
                        checked={statusFilter.includes(status)}
                        onChange={(e) => {
                          if (e.target.checked) {
                            setStatusFilter([...statusFilter, status]);
                          } else {
                            setStatusFilter(statusFilter.filter((s: EventStatus) => s !== status));
                          }
                        }}
                      />
                      <span className="ml-2 text-gray-600">{status.replace('_', ' ')}</span>
                    </label>
                  ))}
                </div>
              </div>
            </div>
          </div>          <div className="flex-1 overflow-y-auto p-4 trc-upcoming-events-container">
            <div className="space-y-3">
            {isClient ? (
              upcomingEvents.length > 0 ? (
                upcomingEvents.map((event: TRCEvent) => (
                  <div
                    key={event.id}
                    onClick={() => {
                      setSelectedEvent(event);
                      setShowEventModal(true);
                    }}
                    className="p-3 bg-white rounded-lg shadow-sm border border-gray-200 hover:border-blue-300 cursor-pointer transition-colors trc-upcoming-event-card"
                  >
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <h5 className="font-medium text-gray-900 text-sm leading-tight">
                          {event.title}
                        </h5>
                        <p className="text-xs text-gray-500 mt-1">
                          {new Date(event.startDate).toLocaleDateString()}
                        </p>
                      </div>
                      <div className="ml-2 flex flex-col space-y-1">
                        <span className={cn(
                          'px-2 py-0.5 text-xs font-medium rounded',
                          getEventTypeColor(event.type)
                        )}>
                          {event.type.replace('_', ' ').toUpperCase()}
                        </span>
                        <span className={cn(
                          'px-2 py-0.5 text-xs font-medium rounded',
                          getPriorityColor(event.priority)
                        )}>
                          {event.priority.toUpperCase()}
                        </span>
                      </div>
                    </div>
                    {event.description && (
                      <p className="text-xs text-gray-600 mt-2 line-clamp-2">
                        {event.description}
                      </p>
                    )}
                  </div>
                ))
              ) : (
                <div className="text-center text-gray-500 py-8">
                  <DocumentTextIcon className="w-8 h-8 mx-auto text-gray-400 mb-2" />
                  <p className="text-sm">No upcoming events</p>
                </div>
              )
            ) : (
              <div className="text-center text-gray-500 py-8">
                <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"></div>
                <p className="text-sm">Loading events...</p>
              </div>
            )}
            </div>
          </div>
        </div>
      </div>

      {/* Event Modals */}
      {showEventModal && selectedEvent && (
        <EventModal
          event={selectedEvent}
          isOpen={showEventModal}
          onClose={() => {
            setShowEventModal(false);
            setSelectedEvent(null);
          }}
          onSave={handleEventSave}
          onDelete={handleEventDelete}
          canEdit={config.enableAdmin || false}
        />
      )}

      {showAddModal && selectedEvent && (
        <AddEventModal
          event={selectedEvent}
          isOpen={showAddModal}
          onClose={() => {
            setShowAddModal(false);
            setSelectedEvent(null);
            setIsEditMode(false);
          }}
          onSave={handleEventSave}
          isEditMode={isEditMode}
        />
      )}
    </div>
  );
}
